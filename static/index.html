<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Metadata Deployer</title>
    <!-- CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/7.0.0/diff.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>

    <!-- Alpine.js for some simple state (optional, sticking to vanilla JS for logic mostly) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa',
                            500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a',
                        },
                        salesforce: '#00a1e0'
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* CustomScrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
        }

        /* Diff2Html custom overrides for dark mode */
        .dark .d2h-file-header {
            background-color: #1f2937;
            border-color: #374151;
            color: #f3f4f6;
        }

        .dark .d2h-file-wrapper {
            border-color: #374151;
        }

        .dark .d2h-code-line {
            color: #d1d5db;
        }

        .dark .d2h-code-line-ctn {
            background-color: #111827;
        }

        .dark .d2h-ins {
            background-color: rgba(52, 211, 153, 0.15);
            border-color: rgba(52, 211, 153, 0.3);
        }

        .dark .d2h-del {
            background-color: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.3);
        }

        .dark .d2h-code-linenumber {
            background-color: #1f2937;
            color: #9ca3af;
            border-color: #374151;
        }

        .dark .d2h-info {
            background-color: #374151;
        }

        .dark .d2h-file-diff {
            overflow-x: auto;
        }

        /* Glassmorphism effects */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dark .glass {
            background: rgba(31, 41, 55, 0.7);
            border: 1px solid rgba(55, 65, 81, 0.5);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 w-full glass shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-salesforce" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M17.447 9.55c-.287-3.078-2.583-5.55-5.447-5.55-2.22 0-4.137 1.34-5.045 3.25C6.447 7.025 6 7.375 6 7.825c0 .03.003.06.01.09C4.303 8.356 3 9.873 3 11.675 3 13.784 4.708 15.5 6.818 15.5h10.91A4.277 4.277 0 0022 11.225c0-2.31-1.848-4.2-4.14-4.24-.138-.002-.276-.01-.413-.01v-1.425z" />
                    </svg>
                    <div>
                        <h1 class="text-xl font-semibold tracking-tight">Salesforce <span
                                class="text-salesforce">Deployer</span></h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">Stateless Proxy Edition</p>
                    </div>
                </div>
                <div>
                    <button id="themeToggleBtn"
                        class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-salesforce">
                        <!-- Sun Icon (visible in dark mode) -->
                        <svg id="themeToggleLightIcon" class="hidden w-5 h-5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                        <!-- Moon Icon (visible in light mode) -->
                        <svg id="themeToggleDarkIcon" class="hidden w-5 h-5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- Orgs Config Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 fade-in" style="animation-delay: 0.1s;">
            <!-- Source Org -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow">
                <div
                    class="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="text-lg font-medium flex items-center gap-2">
                        <span
                            class="p-1.5 bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400 rounded-lg"><svg
                                class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg></span>
                        Source Org
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Instance
                            URL</label>
                        <input type="text" id="srcInstance" placeholder="https://na139.salesforce.com"
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all placeholder-gray-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Session ID <span
                                class="text-xs text-gray-400 font-normal">(Access Token)</span></label>
                        <input type="password" id="srcSession" placeholder="00D... !..."
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all placeholder-gray-400 font-mono">
                    </div>
                </div>
            </div>

            <!-- Target Org -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow">
                <div
                    class="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <h3 class="text-lg font-medium flex items-center gap-2">
                        <span
                            class="p-1.5 bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400 rounded-lg"><svg
                                class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg></span>
                        Target Org
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Instance
                            URL</label>
                        <input type="text" id="tgtInstance" placeholder="https://na140.salesforce.com"
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all placeholder-gray-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Session ID <span
                                class="text-xs text-gray-400 font-normal">(Access Token)</span></label>
                        <input type="password" id="tgtSession" placeholder="00D... !..."
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all placeholder-gray-400 font-mono">
                    </div>
                </div>
            </div>
        </section>

        <!-- Manifest Section -->
        <section
            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden fade-in"
            style="animation-delay: 0.2s;">
            <div class="p-6">
                <div class="flex flex-col sm:flex-row gap-6">
                    <div class="flex-1 space-y-3">
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                            <div>
                                <label class="block text-base font-medium text-gray-900 dark:text-gray-100">Package.xml
                                    Manifest</label>
                                <p class="text-sm text-gray-500 max-w-2xl mt-1">Define the specific metadata components
                                    you want to retrieve and compare between the Source and Target organizations.</p>
                            </div>

                            <!-- Presets -->
                            <div class="flex flex-wrap gap-2 relative z-10">
                                <span
                                    class="text-xs text-gray-400 self-center uppercase font-semibold tracking-wider mr-1 pointer-events-none">Presets</span>
                                <button type="button"
                                    class="preset-btn px-3 py-1.5 text-xs font-medium rounded-md bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 dark:bg-blue-900/40 dark:text-blue-300 dark:border-blue-800 dark:hover:bg-blue-900/60 transition-colors cursor-pointer"
                                    data-preset="code">Code</button>
                                <button type="button"
                                    class="preset-btn px-3 py-1.5 text-xs font-medium rounded-md bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-200 dark:bg-purple-900/40 dark:text-purple-300 dark:border-purple-800 dark:hover:bg-purple-900/60 transition-colors cursor-pointer"
                                    data-preset="nocode">No Code</button>
                                <button type="button"
                                    class="preset-btn px-3 py-1.5 text-xs font-medium rounded-md bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200 dark:bg-amber-900/40 dark:text-amber-300 dark:border-amber-800 dark:hover:bg-amber-900/60 transition-colors cursor-pointer"
                                    data-preset="config">Config</button>
                            </div>
                        </div>
                        <textarea id="packageXml" rows="10"
                            class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-sm font-mono text-blue-600 dark:text-blue-400 focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all resize-y"><types>
    <members>*</members>
    <name>ApexClass</name>
</types>
<version>58.0</version></textarea>
                    </div>

                    <div class="sm:w-64 flex flex-col justify-end">
                        <button id="btnRetrieve"
                            class="w-full flex items-center justify-center gap-2 bg-salesforce hover:bg-blue-600 text-white px-6 py-3.5 border border-transparent rounded-lg font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-salesforce transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            Fetch & Compare
                        </button>
                    </div>
                </div>

                <!-- Retrieve Progress -->
                <div id="retrieveStatus"
                    class="hidden mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-100 dark:border-blue-800/30">
                    <div class="flex justify-between text-sm mb-2">
                        <span id="retrieveMsg" class="font-medium text-blue-800 dark:text-blue-300 text-sm">Initializing
                            connection...</span>
                    </div>
                    <div class="w-full bg-blue-200 dark:bg-blue-900/50 rounded-full h-2.5 overflow-hidden">
                        <div id="retrieveProgress"
                            class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Diff & Deploy Section -->
        <section id="diffSection"
            class="hidden bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden fade-in">
            <div
                class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center">
                <h3 class="text-lg font-medium flex items-center gap-2">
                    <span
                        class="p-1.5 bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400 rounded-lg"><svg
                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                            </path>
                        </svg></span>
                    Changed Components
                </h3>
                <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                    id="diffCountBadge">0 files</span>
            </div>

            <!-- Table Container -->
            <div class="max-h-[500px] overflow-y-auto">
                <table class="w-full text-sm text-left whitespace-nowrap">
                    <thead
                        class="text-xs text-gray-500 uppercase bg-gray-50 dark:bg-gray-800 sticky top-0 shadow-sm z-10 border-b border-gray-200 dark:border-gray-700">
                        <tr>
                            <th scope="col" class="p-4 w-4">
                                <div class="flex items-center">
                                    <input id="selectAll" type="checkbox"
                                        class="w-4 h-4 text-salesforce bg-white border-gray-300 rounded focus:ring-salesforce dark:focus:ring-salesforce dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600 cursor-pointer">
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3 font-semibold">Status</th>
                            <th scope="col" class="px-6 py-3 font-semibold w-full">Component Name</th>
                            <th scope="col" class="px-6 py-3"></th>
                        </tr>
                    </thead>
                    <tbody id="diffList" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- JS injected rows -->
                    </tbody>
                </table>
            </div>

            <!-- Deploy Config -->
            <div class="p-6 bg-gray-50/50 dark:bg-gray-800/30 border-t border-gray-200 dark:border-gray-700">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Specific Test
                            Classes <span class="text-xs text-gray-400 font-normal">(comma separated)</span></label>
                        <input type="text" id="testClasses" placeholder="MyTestClass1, MyUtilTest"
                            class="w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all placeholder-gray-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Test
                            Level</label>
                        <select id="testLevel"
                            class="w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-salesforce focus:border-transparent outline-none transition-all cursor-pointer">
                            <option value="NoTestRun">NoTestRun</option>
                            <option value="RunSpecifiedTests">RunSpecifiedTests</option>
                            <option value="RunLocalTests">RunLocalTests</option>
                            <option value="RunAllTestsInOrg">RunAllTestsInOrg</option>
                        </select>
                    </div>
                    <div>
                        <button id="btnDeploy"
                            class="w-full flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 border border-transparent rounded-lg font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Deploy Selected
                        </button>
                    </div>
                </div>

                <!-- Deploy Progress -->
                <div id="deployStatus"
                    class="hidden mt-6 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg p-4 border border-emerald-100 dark:border-emerald-800/30">
                    <div class="flex justify-between text-sm mb-2">
                        <span id="deployMsg"
                            class="font-medium text-emerald-800 dark:text-emerald-300 text-sm">Preparing
                            deployment...</span>
                    </div>
                    <div class="w-full bg-emerald-200 dark:bg-emerald-900/50 rounded-full h-2.5 overflow-hidden">
                        <div id="deployProgress"
                            class="bg-emerald-600 h-2.5 rounded-full transition-all duration-300 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Diff Modal Overlay -->
    <div id="diffModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <!-- Modal panel -->
            <div
                class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle w-full max-w-5xl border border-gray-200 dark:border-gray-700">
                <div
                    class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/80">
                    <h3 class="text-lg leading-6 font-semibold text-gray-900 dark:text-white" id="modalTitle">File Diff
                    </h3>
                    <button id="closeModal" type="button"
                        class="bg-transparent rounded-lg p-1.5 ml-auto inline-flex items-center text-gray-400 hover:text-gray-900 hover:bg-gray-200 dark:hover:bg-gray-700 dark:hover:text-white transition-colors focus:outline-none">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <div id="diffViewer" class="w-full text-sm"></div>
                </div>
                <!-- Action bar instead to close? -->
            </div>
            <!-- The Logic -->
            <script src="/static/main.js"></script>
            <script>
                // Inline Theme Init script (Tailwind)
                const themeToggleDarkIcon = document.getElementById('themeToggleDarkIcon');
                const themeToggleLightIcon = document.getElementById('themeToggleLightIcon');
                const themeToggleBtn = document.getElementById('themeToggleBtn');

                // Initial setup based on localStorage or OS prefs
                if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    themeToggleLightIcon.classList.remove('hidden');
                } else {
                    themeToggleDarkIcon.classList.remove('hidden');
                }

                themeToggleBtn.addEventListener('click', function () {
                    themeToggleDarkIcon.classList.toggle('hidden');
                    themeToggleLightIcon.classList.toggle('hidden');

                    if (localStorage.getItem('color-theme')) {
                        if (localStorage.getItem('color-theme') === 'light') {
                            document.documentElement.classList.add('dark');
                            localStorage.setItem('color-theme', 'dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                            localStorage.setItem('color-theme', 'light');
                        }
                    } else {
                        if (document.documentElement.classList.contains('dark')) {
                            document.documentElement.classList.remove('dark');
                            localStorage.setItem('color-theme', 'light');
                        } else {
                            document.documentElement.classList.add('dark');
                            localStorage.setItem('color-theme', 'dark');
                        }
                    }
                });
            </script>
</body>

</html>